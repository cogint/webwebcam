<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>QR Code Reader</title>
</head>
<body>
<video autoplay playsinline muted></video>
<script src="https://cozmo.github.io/jsQR/jsQR.js"></script>
<script>
    let video = document.querySelector('video');


    async function getMedia() {
        try {
            return await navigator.mediaDevices.getUserMedia({
                video: true
            });
        } catch (e) {
            console.error(`${e.name}: ${e.message}`);
        }
    }


    let runScanner = true;
    async function scan(){
        let canvas = document.createElement('canvas');
        //let canvas  = document.querySelector('canvas');
        let ctx = canvas.getContext("2d");
        canvas.height = video.videoHeight;
        canvas.width = video.videoWidth;

        while (runScanner){
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            let imageData = ctx.getImageData(0,0,canvas.width, canvas.height);
            let code = jsQR(imageData.data, imageData.width, imageData.height, {});

            if(code){
                if(code.data.toLowerCase().includes("phonecam")) {
                    console.log(code.data);
                    let peerId = JSON.parse(code.data);
                    if(peerId) {
                        console.log(peerId.id);
                    }

                }
            }
        }


        //requestAnimationFrame(scan);

    }

    getMedia().then(stream=>{
        video.srcObject = stream;
    });

    video.onloadeddata = ()=> scan();



</script>
</body>
</html>
